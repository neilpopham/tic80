flr=math.floor
ceil=math.ceil
abs=math.abs
min=math.min
max=math.max
function mid(a,b,c) t={a,b,c} table.sort(t) return t[2] end
function round(x) return flr(x+0.5) end

local screen={width=240,height=136}

function create_camera(item,x,y)
 local c={
  target=item,
  x=item.x,
  y=item.y,
  buffer={x=32,y=16},
  min={x=8*flr(screen.width/16),y=8*flr(screen.height/16)},
  max={x=x-screen.width,y=y-screen.height,shift=2},
  tiles={width=flr(screen.width/8),height=flr(screen.height/8)},
  cell={},
  offset={}
 }
 c.map=function(self)
  self.cell.x=flr(self.x/8)
  self.cell.y=flr(self.y/8)
  self.offset.x=-(self.x%8)
  self.offset.y=-(self.y%8)
  map(
   self.cell.x,
   self.cell.y,
   self.tiles.width+1,
   self.tiles.height+1,
   self.offset.x,
   self.offset.y,
   0
  )
 end
 -- simple camera
 c.update=function(self)
   --[[
  self.x=math.max(0,self.target.x-self.min.x)
  self.x=math.min(self.x,self.max.x)
  self.y=math.max(0,self.target.y-self.min.y)
  self.y=math.min(self.y,self.max.y)
  ]]
  --[[
  self.x=mid(0,self.target.x-self.min.x,self.max.x)
  self.y=mid(0,self.target.y-self.min.y,self.max.y)
  ]]
  self.x=math.min(math.max(0,self.target.x-self.min.x),self.max.x)
  self.y=math.min(math.max(0,self.target.y-self.min.y),self.max.y)
 end
 -- camera with buffer zone
 c.update=function(self)
  self.min_x=self.x+self.min.x-self.buffer.x
  self.max_x=self.x+self.min.x+self.buffer.x
  self.min_y=self.y+self.min.y-self.buffer.y
  self.max_y=self.y+self.min.y+self.buffer.y
  if self.min_x>self.target.x then
   self.x=self.x+min(self.target.x-self.min_x,self.max.shift)
  elseif self.max_x<self.target.x then
   self.x=self.x+min(self.target.x-self.max_x,self.max.shift)
  end
  if self.min_y>self.target.y then
   self.y=self.y+min(self.target.y-self.min_y,self.max.shift)
  elseif self.max_y<self.target.y then
   self.y=self.y+min(self.target.y-self.max_y,self.max.shift)
  end
  --[[
  self.x=mid(0,self.x,self.max.x)
  self.y=mid(0,self.y,self.max.y)
  ]]
  self.x=math.min(math.max(0,self.x),self.max.x)
  self.y=math.min(math.max(0,self.y),self.max.y)
 end
 c.spr=function(self,sprite,x,y)
  spr(sprite,x-self.x,y-self.y,0)
 end
 return c
end

function create_item(x,y)
 local i={
  x=x,
  y=y
 }
 return i
end

function _init()
  p=create_item(40,40)
  p.camera=create_camera(p,512,256)
  x=160 d=1
end

function _update60()
  if btn(0) then p.y=p.y-1 end
  if btn(1) then p.y=p.y+1 end
  if btn(2) then p.x=p.x-1 end
  if btn(3) then p.x=p.x+1 end
  p.camera:update()

  if x > 280 then d=-1 end
  if x < 64 then d=1 end
  x=x+d

  _draw()
end

function _draw()
 cls()
 p.camera:map()
 p.camera:spr(1,p.x,p.y)

 p.camera:spr(4,x,160)

 print("player.x: "..p.x, 0, 0)
 print("y: "..p.y, 100, 0)

 print("camera.x: "..p.camera.x, 0, 7)
 print("y: "..p.camera.y, 100, 7)


 print("cell.x: "..p.camera.cell.x,0,14)
 print("y: "..p.camera.cell.y,100,14)

 print("offset.x: "..p.camera.offset.x,0,21)
 print("y: "..p.camera.offset.y,100,21)


 print("min.x: "..p.camera.min.x,0,30)
 print("y: "..p.camera.min.y,100,30)
 print("max.x: "..p.camera.max.x,0,37)
 print("y: "..p.camera.max.y,100,37)

 if type(p.camera.min_x)~=nil then
  print("min_x: "..p.camera.min_x,0,50)
  print("max_x: "..p.camera.max_x,0,57)
  print("min_y: "..p.camera.min_y,0,64)
  print("max_y: "..p.camera.max_y,0,71)
 end
 
 --mset(flr(p.x/8), flr(p.y/8), 4)

end

function TIC() _update60() end

_init()
-- <TILES>
-- 001:6666666666666666666666666666666666666666666666666666666666666666
-- 002:3333333333333333333333333333333333333333333333333333333333333333
-- 003:5555555555555555555555555555555555555555555555555555555555555555
-- 004:dddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd
-- </TILES>

-- <MAP>
-- 000:303020000020202020202020200000002020202020202020202000000000000000200000000020202000000000000000202020202020202020202000000030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:302020002020202020200000202020202020202020202020200000000020202020202020202000202020202000000020200020000000002000202020000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:002000202020000020002000202000000020202020000020000000202000002020200020202020200020000020202020002020000000200000200020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:202020002020000020000000002020000020202020202000000020000020202000200000002020000020000000002020202000202020000020000020202000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:000000002020202020000000000020000020000000000000000020200000002020000000202000000020200000202000202020202020000020002000002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:000000002030002000000000000020200020000000002000000000202000002000200000002020002020202000002020200000000000000020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:200000000000002000002020200000200020000000200020002020200020200020200020000020000020200000002020002020200000202020202000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:200000200020202020202000002020200020000000200000000020000020202000002020202000002020000000002020002020202020200020002020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:200020000020200020000000000000000000202020002020000020000000200020000020202000202020200000002000200000000000202020200000002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:200020002020000020000000000000000000202020000020002020000000000020002000200020000000202000000020200000000000202020200000202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:200020000000000000200020202000000020202000002000202020000000200020202000200020000020202020200020000000002020000000000000200020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:202020000000200020200000002020000000000020002000002020000020202000202020200000202000002020202000000000202000000000202020200020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:202020002000000000202020202000002020200000000020200020202000200020000020202000200000002000002020000020200000000020002020202000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:200000000000000000002020200000000000002020202000002020202000202020200020202020200020200020000020202020000000202000200020002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:200020200000200020000000200020202000200000000000202020000000000000002000202020202000002000000020202000000000200020000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:002020000000000000002020202000202020002000000000200020000020000020202000200000000000000000002000000000000000000020000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:002020000000002000202020000020202000202020202000202000202000200020002000202020000020000000200000000000200020000020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 017:002020000000200000000020000020200000000000202000202000002020000000202020000020000020002000000000202020202000000020000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 018:002020202020000020200020000020002000000000200000202020202020002020002000200020002020202000002000002020202000200020000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 019:202000002020202000002020000020000000200020200000202000202000202020202000202020000020002020000000000020200000202000000000202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 020:202000200000000000202020200020002020202020002000202020200000002020002000202000002020200000000000202000200000202020000000202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 021:200000002020202020000000000020202020002020000000200020202000202000200000202020002020200000000000202020000020002000000000000020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 022:200020202020202000202020202020202000202000000000002020202000002020200020002020202000000000002000202020002000202000000000000020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 023:202000002020202020202020200000000020202020202020000000202020202020202000002020202020000020000000002020000020202020200020002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 024:002000202020002020200000002000000000000020200020202020000000000000000000002020202020200000002000002020002020000000000000002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 025:002000002020002000200020202020200000000020202020202000000000002020202020002020202020202020002000202000202020202000000000202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 026:202000002000200000002000200020202020200020002020202020000020202020202020202020202000002020000000000000200000000020202000202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 027:200020200020202020000020202020000000200020002020002020200020200020202020200020200000000000000000200020200000002000202000202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 028:002020002020000020202020202020000000002020000020202020202020200020002020202020202000000000000020202020202020000000202020002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 029:000020200000000000202000202000000020002000000000000000000000200020200000002020202000000000002020000000000000000020200020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 030:300000202020000000200020000000000020002000000020202020202020202020202000202000002020202020202000000000000000002020000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 031:303000000020202020202020202020202000002020000020202020000020200000000000002020202020202020000020202020202020202020000000000030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <PALETTE>
-- 000:140c1c44243430346d4e4a4e854c30346524d04648757161597dced27d2c8595a16daa2cd2aa996dc2cadad45edeeed6
-- </PALETTE>
