// title:  camera
// author: neilpopham@gmail.com
// desc:   testing camera
// script: wren

var T = TIC

class Screen {
	static width { 240 }
	static height { 136 }
	static x2 { 239 }
	static y2 { 135 }
}

class Input {
	static up { T.btn(0) }
	static down { T.btn(1) }
	static left { T.btn(2) }
	static right { T.btn(3) }
}

class Point {
	x { _x }
	y { _y }
	x = (value) { _x = value }
	y = (value) { _y = value }

	construct new(x, y) {
		_x = x
		_y = y
	}

	construct new() {}
}

class Player {
	x { _x }
	y { _y }

	construct new(x, y) {
		_x = x
		_y = y
	}

	update() {
		if (Input.right) {
			_x = _x + 1
		}
		if (Input.left) {
			_x = _x - 1
		}
		if (Input.down) {
			_y = _y + 1
		}
		if (Input.up) {
			_y = _y - 1
		}
		T.spr(1, _x - GameState.camera.x, _y - GameState.camera.y)
	}
}

class Enemy {
	x { _x }
	y { _y }

	construct new(x, y) {
		_x = x
		_y = y
		_dx = 1
	}

	update() {
		_x = _x + _dx
		if (_x > 280) _dx = -1
		if (_x < 64) _dx = 1
		T.spr(4, _x - GameState.camera.x, _y - GameState.camera.y)
	}
}

class Camera {
	x { _x }
	y { _y }

	construct new(target, width, height) {
		_target = target
		_x = target.x
		_y = target.y
		_buffer = Point.new(64, 16)
		_min = Point.new(8 * (Screen.width / 16).floor, 8 * (Screen.height / 16).floor)
		_max = Point.new(width - Screen.width, height - Screen.height)
		_tiles = Point.new((Screen.width / 8).floor, (Screen.height / 8).floor)
		_cell = Point.new()
		_offset = Point.new()
	}

	update_old() {
		_x = (_target.x - _min.x).clamp(0, _max.x)
		_y = (_target.y - _min.y).clamp(0, _max.y)

		_cell.x = (_x / 8).floor
		_cell.y = (_y / 8).floor
		_offset.x = -(_x % 8)
		_offset.y = -(_y % 8)

		T.map(_cell.x, _cell.y, _tiles.x + 1, _tiles.y + 1, _offset.x, _offset.y)
	}

	update() {
		_shift = 2
		_min_x = _x + _min.x - _buffer.x
		_max_x = _x + _min.x + _buffer.x
		_min_y = _y + _min.y - _buffer.y
		_max_y = _y + _min.y + _buffer.y

		if (_min_x > _target.x) {
			_x = _x + (_target.x - _min_x).min(_shift)
		} else {
			if (_max_x < _target.x) {
				_x = _x + (_target.x - _max_x).min(_shift)
			}
		}
		if (_min_y > _target.y) {
			_y = _y + (_target.y - _min_y).min(_shift)
		} else {
			if (_max_y < _target.y) {
				_y = _y + (_target.y - _max_y).min(_shift)
			}
		}
		_x = _x.clamp(0, _max.x)
		_y = _y.clamp(0, _max.y)

		_cell.x = (_x / 8).floor
		_cell.y = (_y / 8).floor
		_offset.x = -(_x % 8)
		_offset.y = -(_y % 8)

		T.map(_cell.x, _cell.y, _tiles.x + 1, _tiles.y + 1, _offset.x, _offset.y)
	}

/*
  self.min_x=self.x+self.min.x-self.buffer.x
  self.max_x=self.x+self.min.x+self.buffer.x
  self.min_y=self.y+self.min.y-self.buffer.y
  self.max_y=self.y+self.min.y+self.buffer.y
  if self.min_x>self.target.x then
   self.x=self.x+min(self.target.x-self.min_x,self.max.shift)
  elseif self.max_x<self.target.x then
   self.x=self.x+min(self.target.x-self.max_x,self.max.shift)
  end
  if self.min_y>self.target.y then
   self.y=self.y+min(self.target.y-self.min_y,self.max.shift)
  elseif self.max_y<self.target.y then
   self.y=self.y+min(self.target.y-self.max_y,self.max.shift)
  end
  --[[
  self.x=mid(0,self.x,self.max.x)
  self.y=mid(0,self.y,self.max.y)
  ]]
  self.x=math.min(math.max(0,self.x),self.max.x)
  self.y=math.min(math.max(0,self.y),self.max.y)
*/
}

class GameState {
	static game { __game }
	static game = (value) { __game = value }
	static camera { __game.camera }
}

class Game is TIC {
	camera { _camera }
	player { _player }
	enemy { _enemy }

	construct new() {
		_player = Player.new(4, 4)
		_enemy = Enemy.new(160, 160)
		_camera = Camera.new(_player, 512, 256)
		//Camera.new(_player, 512, 256)
		GameState.game = this
	}

	TIC() {
		T.cls(0)
		camera.update()
		player.update()
		enemy.update()
		//camera.update()
		T.print(_enemy.x,0,0,6)
	}
}

// <TILES>
// 001:6666666666666666666666666666666666666666666666666666666666666666
// 002:3333333333333333333333333333333333333333333333333333333333333333
// 003:5555555555555555555555555555555555555555555555555555555555555555
// 004:dddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd
// 005:cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
// </TILES>

// <MAP>
// 000:303020000020202020202020200000002020202020202020202000000000000000200000000020202000000000000000202020202020202020202000000030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 001:302020002020202020200000202020202020202020202020200000000020202020202020202000202020202000000020200020000000002000202020000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 002:002000202020000020002000202000000020202020000020000000202000002020200020202020200020000020202020002020000000200000200020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 003:202020002020000020000000002020000020202020202000000020000020202000200000002020000020000000002020202000202020000020000020202000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 004:000000002020202020000000000020000020000000000000000020200000002020000000202000000020200000202000202020202020000020002000002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 005:000000002030002000000000000020200020000000002000000000202000002000200000002020002020202000002020200000000000000020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 006:200000000000002000002020200000200020000000200020002020200020200020200020000020000020200000002020002020200000202020202000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 007:200000200020202020202000002020200020000000200000000020000020202000002020202000002020000000002020002020202020200020002020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 008:200020000020200020000000000000000000202020002020000020000000200020000020202000202020200000002000200000000000202020200000002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 009:200020002020000020000000000000000000202020000020002020000000000020002000200020000000202000000020200000000000202020200000202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 010:200020000000000000200020202000000020202000002000202020000000200020202000200020000020202020200020000000002020000000000000200020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 011:202020000000200020200000002020000000000020002000002020000020202000202020200000202000002020202000000000202000000000202020200020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 012:202020002000000000202020202000002020200000000020200020202000200020000020202000200000002000002020000020200000000020002020202000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 013:200000000000000000002020200000000000002020202000002020202000202020200020202020200020200020000020202020000000202000200020002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 014:200020200000200020000000200020202000200000000000202020000000000000002000202020202000002000000020202000000000200020000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 015:002020000000000000002020202000202020002000000000200020000020000020202000200000000000000000002000000000000000000020000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 016:002020000000002000202020000020202000202020202000202000202000200020002000202020000020000000200000000000200020000020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 017:002020000000200000000020000020200000000000202000202000002020000000202020000020000020002000000000202020202000000020000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 018:002020202020000020200020000020002000000000200000202020202020002020002000200020002020202000002000002020202000200020000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 019:202000002020202000002020000020000000200020200000202000202000202020202000202020000020002020000000000020200000202000000000202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 020:202000200000000000202020200020002020202020002000202020200000002020002000202000002020200000000000202000200000202020000000202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 021:200000002020202020000000000020202020002020000000200020202000202000200000202020002020200000000000202020000020002000000000000020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 022:200020202020202000202020202020202000202000000000002020202000002020200020002020202000000000002000202020002000202000000000000020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 023:202000002020202020202020200000000020202020202020000000202020202020202000002020202020000020000000002020000020202020200020002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 024:002000202020002020200000002000000000000020200020202020000000000000000000002020202020200000002000002020002020000000000000002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 025:002000002020002000200020202020200000000020202020202000000000002020202020002020202020202020002000202000202020202000000000202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 026:202000002000200000002000200020202020200020002020202020000020202020202020202020202000002020000000000000200000000020202000202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 027:200020200020202020000020202020000000200020002020002020200020200020202020200020200000000000000000200020200000002000202000202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 028:002020002020000020202020202020000000002020000020202020202020200020002020202020202000000000000020202020202020000000202020002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 029:000020200000000000202000202000000020002000000000000000000000200020200000002020202000000000002020000000000000000020200020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 030:300000202020000000200020000000000020002000000020202020202020202020202000202000002020202020202000000000000000002020000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// 031:303000000020202020202020202020202000002020000020202020000020200000000000002020202020202020000020202020202020202020000000000030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// </MAP>

// <WAVES>
// 000:00000000ffffffff00000000ffffffff
// 001:0123456789abcdeffedcba9876543210
// 002:0123456789abcdef0123456789abcdef
// </WAVES>

// <SFX>
// 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
// </SFX>

// <PALETTE>
// 000:140c1c44243430346d4e4a4e854c30346524d04648757161597dced27d2c8595a16daa2cd2aa996dc2cadad45edeeed6
// </PALETTE>
